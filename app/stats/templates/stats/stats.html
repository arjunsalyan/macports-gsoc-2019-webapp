{% extends 'layout.html' %}
{% load static %}

{% block head_scripts %}
    <script type="text/javascript" src="{% static 'js/Chart.min.js' %}"></script>
{% endblock %}

{% block title %}Statistics |{% endblock %}

{% block content %}
    <br>
    <ul class="nav nav-tabs" id="tabs" role="tablist">
        <li class="nav-item">
            <a href="#" class="nav-link active">System Stats</a>
        </li>
        <li class="nav-item">
            <a href="{% url 'stats_port_installations' %}" class="nav-link">Port Installations</a>
        </li>
    </ul>
    <br><br>
    <div class="row">
        <div class="col-lg-7 p-0">
            <canvas id="user-chart"></canvas>
        </div>
        <div class="col-lg-5">
            <p class="text-center" style="font-size: 15px"><i>Opt-in for submitting stats by installing the port <span class="bg-light">mpstats</span>.</i></p>
            <br>
            <table class="table table-striped">
                <tbody>
                <tr>
                    <th scope="row">Total submissions:</th>
                    <td class="text-right">{{ total_submissions }}</td>
                </tr>
                <tr>
                    <th scope="row">Total unique users:</th>
                    <td class="text-right">{{ unique_users }}</td>
                </tr>
                <tr>
                    <th scope="row">Unique users last week:</th>
                    <td class="text-right">{{ last_week }}</td>
                </tr>
                <tr>
                    <th scope="row">Unique users this week:</th>
                    <td class="text-right">{{ current_week }}</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <br>
    <hr>
    <br>
    {% csrf_token %}
    <form id="duration-selector" class="bg-light p-2 form form-inline justify-content-center" method="get" action="{% url 'stats' %}#duration-selector">
        <lable for="days">Displaying statistics for <strong>{{ users_count_in_duration }} users</strong> who made submissions during:</lable>
        <select onchange="this.form.submit()" id="days" name="days" class="form-control mx-2">
            {% for i in allowed_days|slice:"1:" %}
                <option value="{{ i }}" {% if days == i %}selected{% endif %}>{{ i }} days</option>
            {% endfor %}
        </select>
        <lable for="days-ago">until</lable>
        <select onchange="this.form.submit()" id="days_ago" name="days_ago" class="form-control ml-2">
            <option value="0" {% if days_ago == 0 %}selected{% endif %}>today</option>
            {% for i in allowed_days|slice:"1:" %}
                <option value="{{ i }}" {% if days_ago == i %}selected{% endif %}>{{ i }} days ago</option>
            {% endfor %}
        </select>
    </form>
    <br>

    <h6 class="text-center p-2">
        <span class="text-muted">Duration selected:</span> <u>{{ start_date|date:"Y-m-d" }}</u> <span class="text-muted">to</span> <u>{{ end_date|date:"Y-m-d" }}</u>
    </h6>

    <br>
    <div class="row">
        <div class="col-md-6">
            <canvas id="macports_version_chart"></canvas>
            <p id="macports_version_chart_loader" class="text-primary text-center">Loading Chart <img width="30px" src="{% static 'images/spinner.gif' %}">
            </p>
        </div>
        <div class="col-md-6">
            <canvas id="macos_version_chart"></canvas>
            <p id="macos_version_chart_loader" class="text-primary text-center">Loading Chart <img width="30px" src="{% static 'images/spinner.gif' %}">
            </p>
        </div>
    </div>
    <br><br><br>
    <canvas id="os_version_chart"></canvas>
    <p id="os_version_chart_loader" class="text-primary text-center">Loading Chart <img width="30px" src="{% static 'images/spinner.gif' %}"></p>
    <br><br><br>
    <canvas id="xcode_version_chart"></canvas>
    <p id="xcode_version_chart_loader" class="text-primary text-center">Loading Chart <img width="30px" src="{% static 'images/spinner.gif' %}"></p>
    <br><br><br>
    <canvas id="clt_version_chart"></canvas>
    <p id="clt_version_chart_loader" class="text-primary text-center">Loading Chart <img width="30px" src="{% static 'images/spinner.gif' %}"></p>
{% endblock %}

{% block script %}
<script type="text/javascript">
    function generateURI(){
        const days = $("#days").val();
        const days_ago = $("#days_ago").val();
        const base = "/api/v1/statistics";
        return base + "?days=" + days + "&days_ago=" + days_ago;
    }

    function BasicSort(a, b) {
        let a_segments = a.label.split(".");
        let b_segments = b.label.split(".");
        if (a_segments > b_segments) {
            return 1;
        } else if (a_segments === b_segments) {
            return 0;
        } else {
            return -1;
        }
    }

    function getColors(length) {
        let pallet = ["#0074D9", "#FF4136", "#2ECC40", "#FF851B", "#7FDBFF", "#B10DC9", "#FFDC00", "#001f3f", "#39CCCC", "#01FF70", "#85144b", "#F012BE", "#3D9970", "#111111", "#AAAAAA", "#7979ea", "#548e7d", "#53cc4d", "#e5ae22", "#3ecbd8"];
        let colors = [];

        for (let i = 0; i < length; i++) {
            colors.push(pallet[i % pallet.length]);
        }

        return colors;
    }

    async function getMacPortsVersionsData() {
        const response = await fetch(generateURI() + "&property=macports_version&sort_by=macports_version");
        const data = await response.json();
        const result = data.result;
        let x = [];
        let y = [];
        for(var i=0; i < result.length; i++){
            x.push(result[i].macports_version);
            y.push(result[i].count);
        }
        return {x, y};
    }
    async function drawMacPortsVersionsChart() {
        const ctx = document.getElementById('macports_version_chart').getContext('2d');
        let data = {
            labels: [],
            datasets: []
        };
        const myChart = new Chart(ctx, {
            type: 'pie',
            data: data,
            options: {
					title: {
						display: true,
						text: 'MacPorts Version'
					},
					responsive: true
				}
        });
        const result = await getMacPortsVersionsData();
        let keys = Object.keys(result);
        let datasets = [
            {
                label: 'Users',
                backgroundColor: getColors(result.y.length),
                data: result.y,
            }
        ];
        data.labels = result.x;
        data.datasets = datasets;
        $("#macports_version_chart_loader").hide();
        myChart.update();
    }

    async function getMacOSVersionsData() {
        const response = await fetch(generateURI() + "&property=os_version&sort_by=os_version");
        const data = await response.json();
        const result = data.result;
        let x = [];
        let y = [];
        for(var i=0; i < result.length; i++){
            x.push(result[i].os_version);
            y.push(result[i].count);
        }
        return {x, y};
    }
    async function drawMacOSVersionsChart() {
        const ctx = document.getElementById('macos_version_chart').getContext('2d');
        let data = {
            labels: [],
            datasets: []
        };
        const myChart = new Chart(ctx, {
            type: 'pie',
            data: data,
            options: {
					title: {
						display: true,
						text: 'OSX Version'
					},
					responsive: true
				}
        });
        const result = await getMacOSVersionsData();
        let datasets = [
            {
                label: 'Users',
                backgroundColor: getColors(result.y.length),
                data: result.y,
            }
        ];
        data.labels = result.x;
        data.datasets = datasets;
        $("#macos_version_chart_loader").hide();
        myChart.update();
    }

    async function getOSVersionsData() {
        const response = await fetch(generateURI() + "&property=os_version&property=build_arch&property=cxx_stdlib&sort_by=os_version");
        const data = await response.json();
        const result = data.result;
        for(let i=0; i<result.length; i++) {
            result[i]["grouper"] = result[i].build_arch + '/' + result[i].cxx_stdlib;
        }
        let group = result.reduce((r, a) => {
            r[a.grouper] = [...r[a.grouper] || [], a];
            return r;
        }, {});

        const dataMap = {};
        for(let i=0; i<result.length; i++) {
            let key = result[i].os_version;
            dataMap[key] = 0;
        }

        let datasets = {};

        for(let key in group) {
            let d = Object.assign({}, dataMap);
            if(group.hasOwnProperty(key)) {
                let g = group[key];
                for(let i=0; i<g.length; i++) {
                    let keyInner = g[i].os_version;
                    d[keyInner] = g[i].count;
                }
            }
            datasets[key] = d;
        }
        return datasets;
    }
    async function drawOSVersionsChart() {
        const ctx = document.getElementById('os_version_chart').getContext('2d');
        let data = {
            labels: [],
            datasets: []
        };
        const myChart = new Chart(ctx, {
            type: 'bar',
            data: data,
            options: {
					title: {
						display: true,
						text: 'MacOS Versions'
					},
					tooltips: {
						mode: 'nearest',
						intersect: true
					},
					responsive: true,
					scales: {
						xAxes: [{
							stacked: true,
						}],
						yAxes: [{
							stacked: true
						}]
					}
				}
        });
        const result = await getOSVersionsData();
        let keys = Object.keys(result);
        let datasets = [];
        let c = 0;
        for(let key in result) {
            if(result.hasOwnProperty(key)) {
                let obj = {
                    label: key,
                    backgroundColor: getColors(keys.length)[c],
                    data: Object.values(result[key])
                };
                c++;
                datasets.push(obj);
            }
        }
        datasets.sort(BasicSort);
        data.labels = Object.keys(result[keys[0]]);
        data.datasets = datasets;
        $("#os_version_chart_loader").hide();
        myChart.update();
    }

    async function getXCodeVersionsData() {
        const response = await fetch(generateURI() + "&property=os_version&property=xcode_version&sort_by=os_version");
        const data = await response.json();
        const result = data.result;
        let group = result.reduce((r, a) => {
            r[a.xcode_version] = [...r[a.xcode_version] || [], a];
            return r;
        }, {});

        const dataMap = {};
        for (let i = 0; i < result.length; i++) {
            let key = result[i].os_version;
            dataMap[key] = 0;
        }

        let datasets = {};

        for (let key in group) {
            let d = Object.assign({}, dataMap);
            if (group.hasOwnProperty(key)) {
                let g = group[key];
                for (let i = 0; i < g.length; i++) {
                    let keyInner = g[i].os_version;
                    d[keyInner] = g[i].count;
                }
            }
            datasets[key] = d;
        }
        return datasets;
    }

    async function drawXcodeVersionsChart() {
        const ctx = document.getElementById('xcode_version_chart').getContext('2d');
        let data = {
            labels: [],
            datasets: []
        };
        const myChart = new Chart(ctx, {
            type: 'bar',
            data: data,
            options: {
                title: {
                    display: true,
                    text: 'XCode Versions'
                },
                tooltips: {
                    mode: 'nearest',
                    intersect: true
                },
                responsive: true,
                scales: {
                    xAxes: [{
                        stacked: true,
                    }],
                    yAxes: [{
                        stacked: true
                    }]
                },
                legend: {
                    display: true
                },
            }
        });
        const result = await getXCodeVersionsData();
        let keys = Object.keys(result);
        let datasets = [];
        let c = 0;
        for (let key in result) {
            if (result.hasOwnProperty(key)) {
                let obj = {
                    label: key,
                    backgroundColor: getColors(keys.length)[c],
                    data: Object.values(result[key])
                };
                c++;
                datasets.push(obj);
            }
        }
        datasets.sort(BasicSort);
        data.labels = Object.keys(result[keys[0]]);
        data.datasets = datasets;
        $("#xcode_version_chart_loader").hide();
        myChart.update();
    }
    async function getCLTVersionsData() {
        const response = await fetch(generateURI() + "&property=os_version&property=clt_version&sort_by=os_version");
        const data = await response.json();
        const result = data.result;
        let group = result.reduce((r, a) => {
            r[a.clt_version] = [...r[a.clt_version] || [], a];
            return r;
        }, {});

        const dataMap = {};
        for (let i = 0; i < result.length; i++) {
            let key = result[i].os_version;
            dataMap[key] = 0;
        }

        let datasets = {};

        for (let key in group) {
            let d = Object.assign({}, dataMap);
            if (group.hasOwnProperty(key)) {
                let g = group[key];
                for (let i = 0; i < g.length; i++) {
                    let keyInner = g[i].os_version;
                    d[keyInner] = g[i].count;
                }
            }
            datasets[key] = d;
        }
        return datasets;
    }

    async function drawCLTVersionsChart() {
        const ctx = document.getElementById('clt_version_chart').getContext('2d');
        let data = {
            labels: [],
            datasets: []
        };
        const myChart = new Chart(ctx, {
            type: 'bar',
            data: data,
            options: {
                title: {
                    display: true,
                    text: 'CLT Versions'
                },
                tooltips: {
                    mode: 'nearest',
                    intersect: true
                },
                responsive: true,
                scales: {
                    xAxes: [{
                        stacked: true,
                    }],
                    yAxes: [{
                        stacked: true
                    }]
                },
                legend: {
                    display: true
                },
            }
        });
        const result = await getCLTVersionsData();
        let keys = Object.keys(result);
        let datasets = [];
        let c = 0;
        for (let key in result) {
            if (result.hasOwnProperty(key)) {
                let obj = {
                    label: key,
                    backgroundColor: getColors(keys.length)[c],
                    data: Object.values(result[key])
                };
                c++;
                datasets.push(obj);
            }
        }
        datasets.sort(BasicSort);
        data.labels = Object.keys(result[keys[0]]);
        data.datasets = datasets;
        $("#clt_version_chart_loader").hide();
        myChart.update();
    }
    function drawUserChart() {
        const ctx = document.getElementById('user-chart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [{% for i in users_by_month %}"{{ i.month|date:"M Y" }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    label: "Users",
                    backgroundColor: "#5dc5bf",
                    fill: false,
                    data: [{% for i in users_by_month %}"{{ i.num }}"{% if not forloop.last %}, {% endif %}{% endfor %}]
                }]
            },
            options: {
                title: {
                    display: true,
                    text: 'Users'
                },
                tooltips: {
                    mode: 'nearest',
                    intersect: true
                },
                responsive: true,
                scales: {
                    xAxes: [{
                        stacked: true,
                    }],
                    yAxes: [{
                        stacked: true
                    }]
                },
                legend: {
                    display: true
                },
            }
        });
    }
    drawUserChart();
    drawMacOSVersionsChart();
    drawMacPortsVersionsChart();
    drawOSVersionsChart();
    drawXcodeVersionsChart();
    drawCLTVersionsChart();
</script>
{% endblock %}
